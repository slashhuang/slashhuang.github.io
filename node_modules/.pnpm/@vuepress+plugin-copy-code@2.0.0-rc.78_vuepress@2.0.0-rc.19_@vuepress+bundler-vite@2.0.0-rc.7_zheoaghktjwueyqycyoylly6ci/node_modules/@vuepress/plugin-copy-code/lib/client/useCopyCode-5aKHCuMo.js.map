{"version":3,"file":"useCopyCode-5aKHCuMo.js","sources":["../../src/client/composables/useCopyCode.ts"],"sourcesContent":["import { useLocaleConfig, wait } from '@vuepress/helper/client'\nimport {\n  useClipboard,\n  useEventListener,\n  useMediaQuery,\n  watchImmediate,\n} from '@vueuse/core'\nimport { computed, nextTick } from 'vue'\nimport { usePageData } from 'vuepress/client'\nimport type { CopyCodePluginLocaleConfig } from '../types.js'\n\nimport '../styles/copy-code.css'\nimport '../styles/vars.css'\n\nexport interface UseCopyCodeOptions {\n  locales: CopyCodePluginLocaleConfig\n  selector: string[]\n\n  /** @default 500 */\n  delay: number\n  /** @default 2000 */\n  duration: number\n  /** @default false */\n  showInMobile?: boolean\n  /** @default [] */\n  ignoreSelector?: string[]\n\n  /**\n   * Transform pre element before copy\n   *\n   * For example, deleting certain elements before copying, or inserting copyright information.\n   *\n   * @param preElement `<pre>` clone Node\n   *\n   * @example\n   * ```js\n   * {\n   *   transform(pre) {\n   *     // Remove all `.ignore` elements\n   *     pre.querySelectorAll('.ignore').remove()\n   *     // insert copyright\n   *     pre.innerHTML += `\\n Copied by VuePress`\n   *   }\n   * }\n   * ```\n   */\n  transform?: (preElement: HTMLElement) => void\n}\n\nconst SHELL_RE = /language-(shellscript|shell|bash|sh|zsh)/\n\nexport const useCopyCode = ({\n  delay = 500,\n  duration = 2000,\n  locales,\n  selector,\n  showInMobile,\n  ignoreSelector = [],\n  transform,\n}: UseCopyCodeOptions): void => {\n  if (__VUEPRESS_SSR__) return\n\n  /**\n   * On small-screen devices, the copy button is not displayed by default in order to prevent\n   * it from obstructing content, as the `:hover` effect can be triggered by `touch` events.\n   */\n  const is419 = useMediaQuery('(max-width: 419px)')\n  const enabled = computed(() => !is419.value || showInMobile)\n\n  const locale = useLocaleConfig(locales)\n  const page = usePageData()\n\n  const insertCopyButton = (codeBlockElement: HTMLElement): void => {\n    if (codeBlockElement.hasAttribute('copy-code')) return\n\n    const copyElement = document.createElement('button')\n\n    copyElement.type = 'button'\n    copyElement.classList.add('vp-copy-code-button')\n    copyElement.setAttribute('aria-label', locale.value.copy)\n    copyElement.setAttribute('data-copied', locale.value.copied)\n\n    codeBlockElement.parentElement?.insertBefore(copyElement, codeBlockElement)\n    codeBlockElement.setAttribute('copy-code', '')\n  }\n\n  const appendCopyButton = async (): Promise<void> => {\n    document.body.classList.toggle('no-copy-code', !enabled.value)\n    if (!enabled.value) return\n\n    await nextTick()\n    await wait(delay)\n    document\n      .querySelectorAll<HTMLElement>(selector.join(','))\n      .forEach(insertCopyButton)\n  }\n\n  watchImmediate(() => [page.value.path, enabled.value], appendCopyButton)\n\n  const { copy } = useClipboard({ legacy: true })\n  const timeoutIdMap = new WeakMap<HTMLElement, ReturnType<typeof setTimeout>>()\n\n  const copyContent = async (\n    codeContainer: HTMLDivElement,\n    codeContent: HTMLPreElement,\n    button: HTMLButtonElement,\n  ): Promise<void> => {\n    const clone = codeContent.cloneNode(true) as HTMLPreElement\n\n    if (ignoreSelector.length) {\n      clone.querySelectorAll(ignoreSelector.join(',')).forEach((node) => {\n        node.remove()\n      })\n    }\n\n    if (transform) transform(clone)\n\n    let text = clone.textContent || ''\n\n    if (SHELL_RE.test(codeContainer.className))\n      text = text.replace(/^ *(\\$|>) /gm, '')\n\n    await copy(text)\n\n    if (duration <= 0) return\n\n    button.classList.add('copied')\n    clearTimeout(timeoutIdMap.get(button))\n    const timeoutId = setTimeout(() => {\n      button.classList.remove('copied')\n      button.blur()\n      timeoutIdMap.delete(button)\n    }, duration)\n    timeoutIdMap.set(button, timeoutId)\n  }\n\n  useEventListener('click', (event) => {\n    const el = event.target as HTMLElement\n\n    if (\n      enabled.value &&\n      el.matches('div[class*=\"language-\"] > button.vp-copy-code-button')\n    ) {\n      const codeContainer = el.parentElement as HTMLDivElement | null\n      const preBlock = el.nextElementSibling as HTMLPreElement | null\n\n      if (!codeContainer || !preBlock) return\n\n      void copyContent(codeContainer, preBlock, el as HTMLButtonElement)\n    }\n  })\n}\n"],"names":["SHELL_RE","useCopyCode","delay","duration","locales","selector","showInMobile","ignoreSelector","transform","is419","useMediaQuery","enabled","computed","locale","useLocaleConfig","page","usePageData","insertCopyButton","codeBlockElement","copyElement","watchImmediate","nextTick","wait","copy","useClipboard","timeoutIdMap","copyContent","codeContainer","codeContent","button","clone","node","text","timeoutId","useEventListener","event","el","preBlock"],"mappings":"iUAiDA,MAAMA,EAAW,2CAEJC,EAAc,CAAC,CAC1B,MAAAC,EAAQ,IACR,SAAAC,EAAW,IACX,QAAAC,EACA,SAAAC,EACA,aAAAC,EACA,eAAAC,EAAiB,CAAA,EACjB,UAAAC,CACF,IAAgC,CAC9B,GAAI,iBAAkB,OAMtB,MAAMC,EAAQC,EAAc,oBAAoB,EAC1CC,EAAUC,EAAS,IAAM,CAACH,EAAM,OAASH,CAAY,EAErDO,EAASC,EAAgBV,CAAO,EAChCW,EAAOC,EAAY,EAEnBC,EAAoBC,GAAwC,CAChE,GAAIA,EAAiB,aAAa,WAAW,EAAG,OAEhD,MAAMC,EAAc,SAAS,cAAc,QAAQ,EAEnDA,EAAY,KAAO,SACnBA,EAAY,UAAU,IAAI,qBAAqB,EAC/CA,EAAY,aAAa,aAAcN,EAAO,MAAM,IAAI,EACxDM,EAAY,aAAa,cAAeN,EAAO,MAAM,MAAM,EAE3DK,EAAiB,eAAe,aAAaC,EAAaD,CAAgB,EAC1EA,EAAiB,aAAa,YAAa,EAAE,CAC/C,EAaAE,EAAe,IAAM,CAACL,EAAK,MAAM,KAAMJ,EAAQ,KAAK,EAX3B,SAA2B,CAClD,SAAS,KAAK,UAAU,OAAO,eAAgB,CAACA,EAAQ,KAAK,EACxDA,EAAQ,QAEb,MAAMU,EAAS,EACf,MAAMC,EAAKpB,CAAK,EAChB,SACG,iBAA8BG,EAAS,KAAK,GAAG,CAAC,EAChD,QAAQY,CAAgB,EAC7B,CAEuE,EAEvE,KAAM,CAAE,KAAAM,CAAK,EAAIC,EAAa,CAAE,OAAQ,EAAK,CAAC,EACxCC,EAAe,IAAI,QAEnBC,EAAc,MAClBC,EACAC,EACAC,IACkB,CAClB,MAAMC,EAAQF,EAAY,UAAU,EAAI,EAEpCrB,EAAe,QACjBuB,EAAM,iBAAiBvB,EAAe,KAAK,GAAG,CAAC,EAAE,QAASwB,GAAS,CACjEA,EAAK,OACP,CAAA,CAAC,EAGCvB,GAAWA,EAAUsB,CAAK,EAE9B,IAAIE,EAAOF,EAAM,aAAe,GAOhC,GALI9B,EAAS,KAAK2B,EAAc,SAAS,IACvCK,EAAOA,EAAK,QAAQ,eAAgB,EAAE,GAExC,MAAMT,EAAKS,CAAI,EAEX7B,GAAY,EAAG,OAEnB0B,EAAO,UAAU,IAAI,QAAQ,EAC7B,aAAaJ,EAAa,IAAII,CAAM,CAAC,EACrC,MAAMI,EAAY,WAAW,IAAM,CACjCJ,EAAO,UAAU,OAAO,QAAQ,EAChCA,EAAO,KACPJ,EAAAA,EAAa,OAAOI,CAAM,CAC5B,EAAG1B,CAAQ,EACXsB,EAAa,IAAII,EAAQI,CAAS,CACpC,EAEAC,EAAiB,QAAUC,GAAU,CACnC,MAAMC,EAAKD,EAAM,OAEjB,GACExB,EAAQ,OACRyB,EAAG,QAAQ,sDAAsD,EACjE,CACA,MAAMT,EAAgBS,EAAG,cACnBC,EAAWD,EAAG,mBAEpB,GAAI,CAACT,GAAiB,CAACU,EAAU,OAE5BX,EAAYC,EAAeU,EAAUD,CAAuB,CACnE,CACF,CAAC,CACH"}